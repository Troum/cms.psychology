name: Deploy (cms.rozenkrants.online)

on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency:
  group: deploy-cms-psychology-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Install sshpass
        run: sudo apt-get update -y && sudo apt-get install -y sshpass

      - name: Deploy via SSH
        env:
          SSH_IP: ${{ secrets.SSH_IP }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASS: ${{ secrets.SSH_PASS }}
          SSH_PATH: ${{ secrets.SSH_PATH }}
        run: |
          set -euo pipefail
          sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_IP" "bash -lc '
            set -euo pipefail
            cd \"$SSH_PATH\"

            echo \"==> Git pull\"
            git fetch --prune origin
            git reset --hard origin/main

            echo \"==> Install dependencies\"
            corepack enable
            pnpm install --frozen-lockfile

            mkdir -p logs

            echo \"==> PM2 restart (dev mode)\"
            export NODE_ENV=development
            export PORT=4208

            if pm2 describe cms-psychology >/dev/null 2>&1; then
              pm2 restart cms-psychology --update-env
            else
              pm2 start bash --name cms-psychology --time -- -lc \"cd $SSH_PATH && corepack enable && pnpm run dev\"
            fi

            pm2 save
          '"
