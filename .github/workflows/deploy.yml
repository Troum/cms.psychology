name: Deploy (cms.rozenkrants.online)

on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency:
  group: deploy-cms-psychology-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install sshpass + rsync
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass rsync

      - name: Sync project to server
        env:
          SSH_IP: ${{ secrets.SSH_IP }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASS: ${{ secrets.SSH_PASS }}
          SSH_PATH: ${{ secrets.SSH_PATH }}
        run: |
          set -euo pipefail
          sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_IP" "mkdir -p '$SSH_PATH'"

          # Важно: не трогаем базу/медиа/логи и .env на сервере
          sshpass -p "$SSH_PASS" rsync -az --delete \
            --exclude ".git/" \
            --exclude "node_modules/" \
            --exclude ".next/" \
            --exclude ".env" --exclude ".env.*" \
            --exclude "cms-psychology.db" --exclude "cms-psychology.db*" \
            --exclude "media/" \
            --exclude "logs/" \
            ./ "$SSH_USER@$SSH_IP:$SSH_PATH/"

      - name: Install, build, restart PM2
        env:
          SSH_IP: ${{ secrets.SSH_IP }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASS: ${{ secrets.SSH_PASS }}
          SSH_PATH: ${{ secrets.SSH_PATH }}
        run: |
          set -euo pipefail
          sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_IP" "bash -lc '
            set -euo pipefail
            cd \"$SSH_PATH\"

            if ! command -v node >/dev/null 2>&1; then
              echo \"node is not installed on server\" >&2
              exit 1
            fi

            if ! command -v pm2 >/dev/null 2>&1; then
              echo \"pm2 is not installed on server\" >&2
              exit 1
            fi

            # pnpm через corepack (node >=16.13)
            corepack enable
            pnpm install --frozen-lockfile

            mkdir -p logs

            export NODE_ENV=development
            export PORT=4208

            # PM2 запускаем через bash с pnpm dev
            if pm2 describe cms-psychology >/dev/null 2>&1; then
              pm2 restart cms-psychology --update-env
            else
              pm2 start bash --name cms-psychology --time -- -lc \"cd $SSH_PATH && corepack enable && pnpm run dev\"
            fi

            pm2 save
          '"


